# MongoDB索引未命中


## 事故现象


- 发布后创建索引

## 事故影响


- 代码中count逻辑未命中新版的所有索引，造成MongoDB数据遍历统计，延迟高达100s，使得整个服务不可用，长达 30 分钟


## 事故排查


- 本地环境检查索引情况，发现索引创建后正常查询没有问题
- 检查慢查询对应的查询语句，发现统计语句缺少product，确认问题
- 修复索引
- 修复错误查询语句

## 暴露问题


- 旧版错误的索引未发生问题，原因在于count统计时的缺少product的错误查询语句刚好满足查询条件

- 由于旧版单用户单租户的性质，所以问题不被发现。



## 规避方案


- 充分进行代码 review， 避免代码中的隐藏问题

- 测试环境数据量级与生产环境尽量保持一致，防止性能上的问题不能及时发现，充分进行压测


## 技术点
- 不要有在服务器启动时执行创建索引操作，因为一点数据库数据过大，就会存在服务启动时间过长，重新启动，并无限重复，导致服务无法启动
- 创建组合索引时一定要注意创建顺序，优先筛选出能最少结果的字段
- mongoengine中如果之前存在过创建索引，比如唯一索引， 之后代码只创建普通索引，那么之前代码唯一索引不会失效，需要手动删除